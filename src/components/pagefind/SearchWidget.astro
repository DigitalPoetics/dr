---
export interface Props {
  placeholder?: string;
  redirectUrl?: string;
}

const { 
  placeholder = "Enter a search termâ€¦",
  redirectUrl = "/search-pagefind"
} = Astro.props;
---

<!-- Search Toggle Button (place this in your header) -->
<button id="search-toggle" class="search-toggle" aria-label="Toggle search">
  <!-- Magnifying Glass Icon -->
  <svg class="search-icon" width="25" height="25" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <circle cx="11" cy="11" r="8"></circle>
    <path d="M21 21l-4.35-4.35"></path>
  </svg>
  <!-- X Close Icon -->
  <svg class="close-icon" width="25" height="25" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: none;">
    <line x1="18" y1="6" x2="6" y2="18"></line>
    <line x1="6" y1="6" x2="18" y2="18"></line>
  </svg>
</button>

<!-- Search Form Container (initially hidden) -->
<aside class="search-form-container" id="search-container" style="display: none;">
  <form class="search-form">
    <input
      type="search"
      required
      min="2"
      max="24"
      name="search"
      id="search"
      placeholder={placeholder}
    />
  </form>
</aside>

<script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.8/purify.min.js" is:inline></script>

<script is:inline define:vars={{ redirectUrl }}>
  document.addEventListener("DOMContentLoaded", () => {
    const searchToggle = document.getElementById("search-toggle");
    const searchContainer = document.getElementById("search-container");
    const searchInput = document.getElementById("search");
    const searchIcon = document.querySelector(".search-icon");
    const closeIcon = document.querySelector(".close-icon");
    const form = document.querySelector(".search-form");
    
    let isSearchOpen = false;

    function openSearch() {
      searchContainer.style.display = "block";
      searchIcon.style.display = "none";
      closeIcon.style.display = "block";
      searchInput.focus();
      isSearchOpen = true;
    }

    function closeSearch() {
      searchContainer.style.display = "none";
      searchIcon.style.display = "block";
      closeIcon.style.display = "none";
      searchInput.value = "";
      isSearchOpen = false;
    }

    // Toggle search on button click
    searchToggle?.addEventListener("click", (e) => {
      e.stopPropagation();
      if (isSearchOpen) {
        closeSearch();
      } else {
        openSearch();
      }
    });

    // Close on click outside
    document.addEventListener("click", (e) => {
      if (!searchContainer.contains(e.target) && !searchInput.contains(e.target)) {
        closeSearch();
      }
    });

    // Close on Escape key
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && isSearchOpen) {
        closeSearch();
      }
    });

    // Prevent closing when clicking inside the search container
    searchContainer?.addEventListener("click", (e) => {
      e.stopPropagation();
    });

    // Handle form submission - REDIRECTS to search page
    form?.addEventListener("submit", (e) => {
      e.preventDefault();
      const formData = new FormData(form);
      const searchTerm = DOMPurify.sanitize(formData.get("search")?.toString());
      if (!searchTerm || searchTerm.length === 0) return;
      const url = new URL(redirectUrl, window.location.origin);
      url.searchParams.set("q", searchTerm);
      window.location.assign(url.toString());
    });
  });
</script>

<style>
  .search-toggle {
    background: none;
    border: none;
    cursor: pointer;
    padding: 0.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: color 0.2s ease;
  }

  .search-toggle svg {
    color: var(--light-text);
    transition: transform 0.2s ease;
  }
  
  html.dark .search-toggle svg {
    color: var(--dark-text);
  }

  .search-toggle:hover svg {
    color: var(--hover-color);
    transform: scale(1.2);
  }

  html.dark .search-toggle:hover svg {
    color: var(--hover-color);
  }

  .search-form-container {
    top: 5rem;
    position: fixed;
    margin: 0 auto;
    width: 90%;
    left: 50%;
    transform: translateX(-50%);
    background: var(--button-background);
    z-index: 999;
    padding: 0;
    animation: slideDown 0.3s ease;
    border-bottom: 3px solid var(--hover-color);
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateX(-50%) translateY(-20px);
    }
    to {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
  }

  #search {
    width: 100%;
    height: 3rem;
    margin: 0;
    padding: 0 0.5rem;
    border: var(--image-border);
    font-family: "IM Fell English", serif;
    font-size: 1.2rem;
    transition: border-color 0.2s ease;
  }

  #search:focus {
    outline: none;
  }

  @media screen and (min-width: 636px) {
    .search-form-container {
      width: 80%;
    }

    #search {
      height: 3.5rem;
      font-size: 1.3rem;
    }
  }
</style>